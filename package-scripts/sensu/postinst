#!/bin/sh
#
# WARNING: REQUIRES /bin/sh
#
# - must run on /bin/sh on solaris 9
# - must run on /bin/sh on AIX 6.x
# - if you think you are a bash wizard, you probably do not understand
#   this programming language.  do not touch.
# - if you are under 40, get peer review from your elders.
#
# Perform necessary sensu setup steps
# after package is installed.
#

PROGNAME=`basename $0`
INSTALLER_DIR=/opt/sensu
CONFIG_DIR=/etc/sensu
USAGE="usage: $0 [-v validation_key] ([-o organization] || [-u url])"

error_exit()
{
  echo "${PROGNAME}: ${1:-"Unknown Error"}" 1>&2
  exit 1
}

is_darwin()
{
  uname -v | grep "^Darwin" 2>&1 >/dev/null
}

is_smartos()
{
  uname -v | grep "^joyent" 2>&1 >/dev/null
}

is_aix()
{
  uname -a | grep "^AIX" 2>&1 >/dev/null
}

is_freebsd()
{
  uname -v | grep "^FreeBSD" 2>&1 >/dev/null
}

create_sensu_user_aix()
{
  # add /bin/false to the list of allowed shells
  # NOTE: this is all terrible and makes kittens cry.
  # it should all be replaced by a single, idempotent command
  /usr/bin/lssec -f /etc/security/login.cfg -s usw -a shells | /usr/bin/grep "/bin/false" > /dev/null
  RC=$?
  if [ "${RC}" != "0" ]; then
    SHVAL=`/usr/bin/lssec -f /etc/security/login.cfg -s usw -a shells | /usr/bin/cut -d '=' -f2`
    /usr/bin/chsec -f /etc/security/login.cfg -s usw -a shells="${SHVAL},/bin/false"
  fi

  # create the system user
  mkuser pgrp="sensu" shell="/bin/false" home="/opt/sensu" sensu
}

create_sensu_user_group()
{
  # create sensu group
  if ! grep "^sensu:" /etc/group >/dev/null; then
    if is_aix; then
      mkgroup sensu
    fi
  fi

  # create sensu user
  if ! grep "^sensu:" /etc/passwd >/dev/null; then
    if is_aix; then
      create_sensu_user_aix
    fi
  fi
}

create_sensu_dirs()
{
  if is_freebsd; then
    mkdir -p /usr/local/etc/sensu
  else
    mkdir -p /etc/sensu
  fi

  mkdir -p /var/log/sensu
}

chown_sensu_dirs()
{
  # Ensure all files/directories in $INSTALLER_DIR are owned by root.
  chown -Rh 0:0 $INSTALLER_DIR
  chown -R sensu:sensu /etc/sensu
  chown -R sensu:sensu /var/log/sensu
}

create_system_services()
{
  if is_aix; then
    rmssys -s sensu-client 2>&1 >/dev/null
    mkssys -s sensu-client -p /opt/sensu/embedded/bin/sensu-client -u sensu -a "-l /tmp/sensu-client.log" 2>&1 >/dev/null
  fi
}

create_sensu_user_group
create_sensu_dirs
chown_sensu_dirs
create_system_services

echo "Thank you for installing Sensu!"

exit 0
EOF
